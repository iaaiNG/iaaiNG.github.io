<!DOCTYPE html>
<html lang="en">

<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <button onclick="change()">点击改变数据</button>
  <hr>
  <div id="mvvm">
    <input type="text" v-model="d">{{text}}
    <section>
      <div>{{d}}</div>
      <ul>
        <li>{{name}}</li>
      </ul>
    </section>
  </div>
</body>
<script>
  function nodeContainer(node, vm, flag) {
    flag = flag || document.createDocumentFragment()
    var child;
    while (child = node.firstChild) {
      complie(child, vm)
      if (child.firstChild) {
        var cloneChild = child.cloneNode()
        node.removeChild(child)
        flag.appendChild(nodeContainer(child, vm, cloneChild))
      } else {
        flag.appendChild(child)
      }
    }
    return flag
  }

  function complie(node, vm) {
    var reg = /\{\{(.*)\}\}/
    if (node.nodeType === 3) {
      if (reg.test(node.nodeValue)) {
        var name = RegExp.$1.trim()
        new Watch(node, vm, name, node.nodeType)
      }
    }
    if (node.nodeType === 1) {
      var res = node.getAttribute("v-model")
      if (res) {
        node.addEventListener("input", e=>{
          vm[res] = node.value
        })
        new Watch(node, vm, res, node.nodeType)
      }
    }

  }

  function Watch(node, vm, name, type) {
    Dep.global = this
    this.node = node
    this.vm = vm
    this.name = name
    this.type = type
    this.update()
    Dep.global = null
  }
  Watch.prototype = {
    update() {
      if (this.type === 3) {
        this.node.nodeValue = this.vm[this.name]

      }
      if (this.type === 1) {
        this.node.value = this.vm[this.name]
      }
    }
  }



  function observe(data, vm) {
    Object.keys(data).forEach(key => {
      var dep = new Dep()
      var value = data[key]
      Object.defineProperty(vm, key, {
        get() {
          if (Dep.global) {
            dep.add(Dep.global)
          }
          return value
        },
        set(newValue) {
          if (value === newValue) return
          value = newValue
          dep.notiy()
        }
      })
    })

  }

  function Dep() {
    this.subs = []
  }
  Dep.prototype = {
    add(sub) {
      this.subs.push(sub)
    },
    notiy() {
      this.subs.forEach(sub => {
        sub.update()
      })
    },
  }

  function Vue(options) {
    this.data = options.data
    var dom = document.getElementById(options.el)
    observe(this.data, this)
    var tar = nodeContainer(dom, this)
    dom.appendChild(tar)
  }

  var Demo = new Vue({
    el: "mvvm",
    data: {
      text: "hello world",
      d: "hello imageDT",
      name:"jkm"
    }
  })

  function change() {
    Demo.d = "hi jkm"
  }
</script>

</html>